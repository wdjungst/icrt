// Generated by CoffeeScript 1.6.1
(function() {

  $(function() {
    var disableButtons, duration, postRooms;
    disableButtons = function(action) {
      if (typeof action === 'undefined') {
        action = '';
      }
      return $('.btn').addClass('disabled', action).attr('disabled', action);
    };
    $('.map').maphilight();
    duration = function() {
      var $duration;
      $duration = $('#duration');
      $duration.html('Loading Times...');
      return $.ajax({
        type: "POST",
        url: '/duration',
        data: "time=" + ($('#time_select option:selected').val()),
        success: function(data) {
          var times;
          times = data.split(',');
          return $duration.html("Showing rooms available from " + times[0] + " to " + times[1]);
        },
        error: function(data) {
          return console.log(data);
        }
      });
    };
    postRooms = function(rooms) {
      var room_ids;
      duration();
      room_ids = [];
      $.each(rooms, function(i, l) {
        return room_ids.push($(l).attr('id'));
      });
      return $.ajax({
        type: "POST",
        url: '/room',
        data: "rooms=" + room_ids + "&time=" + ($('#time_select option:selected').val()),
        success: function(data) {
          var availableRoomIds, availableRooms;
          availableRoomIds = data.split(',');
          $.each(rooms, function(i, l) {
            var $el;
            $el = $(l);
            $el.addClass('not-available');
            if ($el.attr('data-maphilight')) {
              return $el.data("maphilight", {
                fillColor: "FF0000",
                alwaysOn: true
              }).trigger("alwaysOn.maphilight");
            } else {
              return $el.attr('data-maphilight', '{"fillColor":"FF0000","fillOpacity":"0.3", "alwaysOn":true}').trigger("alwaysOn.maphilight");
            }
          });
          availableRooms = [];
          $.each(rooms, function(roomIndex, room) {
            if ($.inArray($(room).attr('id'), availableRoomIds) > -1) {
              return availableRooms.push(room);
            }
          });
          return $.each(availableRooms, function(roomIndex, room) {
            var $el;
            $el = $(room);
            if ($el.attr('data-maphilight')) {
              $el.removeClass('not-available');
              return $el.data("maphilight", {
                fillColor: "228B22",
                alwaysOn: true
              }).trigger("alwaysOn.maphilight");
            } else {
              $el.removeClass('not-available');
              return $el.attr('data-maphilight', '{"fillColor":"228B22","fillOpacity":"0.3", "alwaysOn":true}').trigger("alwaysOn.maphilight");
            }
          });
        },
        error: function(data) {
          return console.log(data);
        }
      });
    };
    postRooms($('.room'));
    $('area').bind('click', function(e) {
      var $area;
      e.preventDefault();
      $area = $(this);
      duration = $('#time_select option:selected').val();
      if (!$area.hasClass('not-available')) {
        return $.ajax({
          type: 'POST',
          url: '/book_room',
          data: "room_id=" + ($area.attr('id')) + "&duration=" + duration,
          success: function(data) {
            var event_details;
            event_details = data.split(',');
            return bootbox.dialog("Room Booked!", [
              {
                label: "Update Event Details",
                id: "book-details",
                callback: function() {
                  $('#event_id').val(event_details[0]);
                  $('#room_name').val(event_details[1]);
                  $('#start_time').val(event_details[2]);
                  $('#end_time').val(event_details[3]);
                  $('#event_title').val(event_details[4]);
                  $('#attendees').val(event_details[5]);
                  return $('#update_modal').modal('show');
                }
              }, {
                label: "Ok",
                id: "book-confirm",
                callback: function() {
                  return postRooms($('.room'));
                }
              }
            ]);
          },
          error: function() {
            $('#update_modal').modal('hide');
            return postRooms($('.room'));
          }
        });
      }
    });
    $('#update_event').bind('click', function(e) {
      e.preventDefault();
      disableButtons('disabled');
      return $.ajax({
        type: 'POST',
        url: '/update_event_details',
        data: $('#update_event_form').serializeArray(),
        success: function(data) {
          $('#update_modal').modal('hide');
          return postRooms($('.room'));
        },
        error: function(data) {}
      });
    });
    $('#cancel_event_update').bind('click', function(e) {
      e.preventDefault();
      return postRooms($('.room'));
    });
    $('#settings').bind('click', function(e) {
      var $settings, $timeFrame;
      $settings = $(this);
      $timeFrame = $('#time_frame');
      return $timeFrame.slideToggle(function() {
        if ($timeFrame.is(':visible')) {
          return $settings.addClass('btn-primary');
        } else {
          return $settings.removeClass('btn-primary');
        }
      });
    });
    return $('#time_select').bind('change', function() {
      $('.room').data("maphilight", {
        alwaysOn: false
      }).trigger("alwaysOn.maphilight");
      return postRooms($('.room'));
    });
  });

}).call(this);
